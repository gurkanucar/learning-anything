<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0"/>
    <title>Authentication Page</title>
    <style>
      body {
        font-family: Arial, sans-serif;
        max-width: 800px;
        margin: 0 auto;
        padding: 20px;
      }
      .login-container {
        display: flex;
        gap: 20px;
        margin-bottom: 20px;
      }
      .login-option {
        flex: 1;
        padding: 20px;
        border: 1px solid #ccc;
        border-radius: 5px;
      }
      button {
        padding: 10px 20px;
        background-color: #0366d6;
        color: white;
        border: none;
        border-radius: 5px;
        cursor: pointer;
        margin: 5px 0;
        width: 100%;
      }
      button:hover {
        background-color: #024ea4;
      }
      .info-section {
        margin-top: 20px;
        padding: 20px;
        border: 1px solid #ccc;
        border-radius: 5px;
        display: none;
      }
      .token-info {
        word-break: break-all;
        margin-top: 10px;
      }
      pre {
        background-color: #f4f4f4;
        padding: 10px;
      }
      hr {
        margin: 30px 0;
      }
    </style>
  </head>
  <body>
    <h1>Authentication Options</h1>
    <div class="login-container">
      <!-- GitHub Login -->
      <div class="login-option">
        <h2>GitHub Login</h2>
        <button onclick="handleGitHubLogin()">Login with GitHub</button>
      </div>

      <!-- Keycloak Login -->
      <div class="login-option">
        <h2>Keycloak Login</h2>
        <input
          type="text"
          id="kc-username"
          placeholder="Username"
          style="width: 100%; margin-bottom: 10px; padding: 8px"
        />
        <input
          type="password"
          id="kc-password"
          placeholder="Password"
          style="width: 100%; margin-bottom: 10px; padding: 8px"
        />
        <button onclick="handleKeycloakLogin()">Login with Keycloak</button>
      </div>
    </div>

    <hr />

    <!-- Keycloak Token Info Section -->
    <div id="keycloakTokenInfo" class="info-section">
      <h2>Keycloak Token Information</h2>
      <div class="token-info">
        <h3>Access Token (Keycloak):</h3>
        <pre id="kc-accessToken"></pre>
        <h3>Refresh Token (Keycloak):</h3>
        <pre id="kc-refreshToken"></pre>
        <button onclick="refreshKeycloakToken()">Refresh Keycloak Access Token</button>
      </div>
    </div>

    <!-- Keycloak User Info -->
    <div id="keycloakUserInfo" class="info-section">
      <h2>Keycloak User Information</h2>
      <pre id="kc-userInfoContent"></pre>
    </div>

    <hr />

    <!-- GitHub Token Info Section -->
    <div id="githubTokenInfo" class="info-section">
      <h2>GitHub Token Information</h2>
      <div class="token-info">
        <h3>Access Token (GitHub):</h3>
        <pre id="gh-accessToken"></pre>
      </div>
    </div>

    <!-- GitHub User Info -->
    <div id="githubUserInfo" class="info-section">
      <h2>GitHub User Information</h2>
      <pre id="gh-userInfoContent"></pre>
    </div>

    <script>
      /**************************************************
       * Configuration (Example Only)
       **************************************************/
      const config = {
        // Keycloak
        keycloakUrl: "http://localhost:8080",
        realm: "general_project",
        clientId: "frontend-client",

        // GitHub
        // We'll retrieve tokens from the backend at http://localhost:3001
        backendUrl: "http://localhost:3001" // Your Express server
      };

      // We'll store Keycloak tokens here
      let keycloakTokens = {
        accessToken: null,
        refreshToken: null,
      };

      // We'll store GitHub token here
      let githubToken = null;

      /**************************************************
       * Keycloak Flow
       **************************************************/
      async function handleKeycloakLogin() {
        const username = document.getElementById("kc-username").value;
        const password = document.getElementById("kc-password").value;

        try {
          const tokenResponse = await fetch(
            `${config.keycloakUrl}/realms/${config.realm}/protocol/openid-connect/token`,
            {
              method: "POST",
              headers: {
                "Content-Type": "application/x-www-form-urlencoded",
              },
              body: new URLSearchParams({
                grant_type: "password",
                client_id: config.clientId,
                username: username,
                password: password,
                scope: "email openid",
              }),
            }
          );

          if (!tokenResponse.ok) {
            throw new Error("Failed to get Keycloak token");
          }

          const tokens = await tokenResponse.json();
          // Store and display them
          await handleKeycloakTokens(tokens);
        } catch (error) {
          console.error("Keycloak Login failed:", error);
          alert("Keycloak Login failed. Check the console for details.");
        }
      }

      async function handleKeycloakTokens(tokens) {
        keycloakTokens = {
          accessToken: tokens.access_token,
          refreshToken: tokens.refresh_token,
        };

        // Update UI
        document.getElementById("kc-accessToken").textContent = tokens.access_token;
        document.getElementById("kc-refreshToken").textContent = tokens.refresh_token;
        document.getElementById("keycloakTokenInfo").style.display = "block";

        // Fetch Keycloak user info
        await fetchKeycloakUserInfo(tokens.access_token);
      }

      async function refreshKeycloakToken() {
        if (!keycloakTokens.refreshToken) {
          alert("No Keycloak refresh token available");
          return;
        }

        try {
          const response = await fetch(
            `${config.keycloakUrl}/realms/${config.realm}/protocol/openid-connect/token`,
            {
              method: "POST",
              headers: {
                "Content-Type": "application/x-www-form-urlencoded",
              },
              body: new URLSearchParams({
                grant_type: "refresh_token",
                client_id: config.clientId,
                refresh_token: keycloakTokens.refreshToken,
              }),
            }
          );

          if (!response.ok) {
            throw new Error("Failed to refresh Keycloak token");
          }

          const tokens = await response.json();
          await handleKeycloakTokens(tokens);
          alert("Keycloak Access token refreshed successfully");
        } catch (error) {
          console.error("Keycloak token refresh failed:", error);
          alert("Failed to refresh Keycloak token. Please login again.");
        }
      }

      async function fetchKeycloakUserInfo(accessToken) {
        try {
          const userInfoResponse = await fetch(
            `${config.keycloakUrl}/realms/${config.realm}/protocol/openid-connect/userinfo`,
            {
              headers: {
                Authorization: `Bearer ${accessToken}`,
              },
            }
          );

          if (!userInfoResponse.ok) {
            throw new Error("Failed to get Keycloak user info");
          }

          const userInfo = await userInfoResponse.json();
          document.getElementById("kc-userInfoContent").textContent =
            JSON.stringify(userInfo, null, 2);
          document.getElementById("keycloakUserInfo").style.display = "block";
        } catch (error) {
          console.error("Keycloak: Failed to fetch user info:", error);
        }
      }

      /**************************************************
       * GitHub Flow
       * 1) handleGitHubLogin() => redirect user to your server or GitHub
       * 2) GitHub redirects user back to your front-end with ?code=...
       * 3) handleGitHubCallback() => we call our backend with code
       **************************************************/
      function handleGitHubLogin() {
        // Option A: Use your backend route that starts the GitHub OAuth flow
        window.location.href = `${config.backendUrl}/github/login`;

        // Option B: Directly go to GitHub (requires your backend callback in GH app):
        // const state = Math.random().toString(36).substring(7);
        // window.location.href = `https://github.com/login/oauth/authorize?client_id=${config.githubClientId}&scope=user:email&state=${state}`;
      }

      async function handleGitHubCallback(code) {
        // We'll call the backend to exchange 'code' for an access token + user info
        try {
          const response = await fetch(
            `${config.backendUrl}/github/callback?code=${code}`
          );
          if (!response.ok) {
            throw new Error("GitHub callback exchange failed");
          }

          const data = await response.json();
          // Data expected: { accessToken, user }
          githubToken = data.accessToken;

          // Update the UI
          document.getElementById("gh-accessToken").textContent = githubToken;
          document.getElementById("githubTokenInfo").style.display = "block";

          // Show user info
          document.getElementById("gh-userInfoContent").textContent = JSON.stringify(
            data.user,
            null,
            2
          );
          document.getElementById("githubUserInfo").style.display = "block";
        } catch (error) {
          console.error("GitHub OAuth Callback error:", error);
          alert("GitHub Login failed. Check console.");
        }
      }

      /**************************************************
       * On Page Load
       * - Check if we have a GitHub 'code' in URL
       **************************************************/
      window.onload = () => {
        const urlParams = new URLSearchParams(window.location.search);
        const code = urlParams.get("code");

        // If we got a GitHub 'code', exchange it
        if (code) {
          handleGitHubCallback(code);
        }
      };
    </script>
  </body>
</html>
